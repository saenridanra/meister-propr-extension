# Requirements: Meister ProPR Extension

## Project overview

`meister-propr-extension` is an Azure DevOps extension that provides AI-powered code reviews for pull requests. A user triggers a review from within Azure DevOps and receives structured AI feedback — a summary plus per-file comments — generated by a Microsoft Foundry agent hosted on the client's own subscription.

---

## Architecture

```
extension/   — ADO web extension (TypeScript + Webpack)  [this repo]
backend/     — ASP.NET Core Web API (.NET 10, C#)        [separate repo]
```

### Component roles

- **Extension** — runs inside Azure DevOps in the browser. Reads settings from ADO extension data storage, fetches PR metadata and changed files via the ADO Git SDK, and POSTs review requests to the backend.
- **Backend** — stateless HTTP API. Validates the incoming client key, instantiates a Microsoft Agents AI agent using the client-supplied Foundry credentials, and returns review results.

---

## Configuration model

Extension configuration is stored in ADO extension data storage (`IExtensionDataService`). Users enter it once in the extension settings panel.

| Setting | Purpose |
|---|---|
| Backend URL | URL of the review backend |
| Client key | Authenticates the ADO org to the backend |

Foundry credentials (endpoint and API key) are configured directly in the backend deployment (e.g. via environment variables or Azure Key Vault) and are never exposed to the extension or its users.

---

## Extension (`extension/`)

### Contributions (vss-extension.json)

- **Settings panel** — a hub in Project Settings where users enter and save the four configuration values via `IExtensionDataService`
- **Review panel** — the primary UI where users trigger an AI review for a PR and view results (summary + per-file comments). The exact ADO contribution point (standalone hub, PR tab, action menu item, etc.) is TBD based on product direction and may evolve over time.

### ADO SDK usage

- `IExtensionDataService` — reads and writes settings from ADO extension data storage
- `GitRestClient` — fetches the list of PR iterations to determine the latest iteration ID
- `SDK.getAccessToken()` — obtains the current user's ADO access token, passed to the backend so it can fetch changed files and post review comments directly against the ADO API

### Generated API client

`npm run generate:api` uses `openapi-typescript-codegen` to generate a typed TypeScript client from `../backend/openapi.json` into `src/generated/`. This client is used by the review panel to call the backend API.

---

## Backend (`backend/`) — maintained in a separate repository

The full API contract is defined in `../backend/openapi.json`.

### `POST /reviews`

Submits a review job. The backend fetches changed files and PR metadata directly from ADO using the supplied token, then processes the review asynchronously.

Request:
- Header: `X-Client-Key: <key>`
- Header: `X-Ado-Token: <token>` — ADO access token used by the backend to call ADO APIs
- Body: `organizationUrl`, `projectId`, `repositoryId`, `pullRequestId`, `iterationId`

Response: `202 Accepted` — `{ jobId }`

### `GET /reviews/{jobId}`

Polls for the result of a previously submitted review job.

Request:
- Header: `X-Client-Key: <key>`

Response:
- `status` — `pending` | `processing` | `completed` | `failed`
- `result` — present when `completed`: `summary` + `comments` (array with optional file path, line number, severity [`info` | `warning` | `error` | `suggestion`], and message)
- `error` — present when `failed`: human-readable error message

### `GET /reviews`

Returns all review jobs submitted under this client key, newest first. Used by the review overview panel.

### Client key validation

The backend maintains a client registry in an EF Core database. On every request, the `X-Client-Key` header value is validated against the registry. Unknown or invalid keys are rejected with `401 Unauthorized`.

Database providers:
- **SqlServer** — production deployments
- **Sqlite** — local development (lightweight, no server required)

### Agent instantiation

The backend uses `Microsoft.Agents.AI` to instantiate a Microsoft Foundry agent per request, configured with the Foundry endpoint and API key from backend configuration (environment variables or Azure Key Vault). No agent state is shared across requests.

---

## Request flow

1. User triggers a review for a PR from within the extension UI
2. Extension reads backend URL and client key from ADO extension data storage via `IExtensionDataService`
3. Extension fetches the list of PR iterations via `GitRestClient` to determine the latest iteration ID; also obtains the current user's ADO token via `SDK.getAccessToken()`
4. Extension sends `POST /reviews` to the backend with:
   - `X-Client-Key: <key>` header
   - `X-Ado-Token: <token>` header
   - `organizationUrl`, `projectId`, `repositoryId`, `pullRequestId`, `iterationId` in the body
5. Backend validates the client key, enqueues the job, and returns `202 Accepted` with a `jobId`
6. Extension polls `GET /reviews/{jobId}` every 3 seconds, showing status to the user
7. Backend processes the review asynchronously: fetches changed files and PR metadata from ADO using the supplied token, instantiates a Microsoft Agents AI agent using Foundry credentials from backend configuration, runs the review, and posts comments back to the PR on the specified iteration
8. Once the job status is `completed`, the extension displays the summary and per-file comments; if `failed`, an error message is shown. Polling times out after 5 minutes.

---

## Non-functional requirements

- **No secrets in the extension** — Foundry credentials are never stored in ADO extension data or transmitted by the browser; they live exclusively in the backend deployment
- **Self-service onboarding** — clients configure the extension themselves with only the backend URL and client key; the backend operator issues the client key and manages Foundry credentials server-side
- **Local dev simplicity** — Sqlite provider requires no external database server for development
- **OpenAPI contract** — the backend exports an `openapi.json` spec (via Swashbuckle) that the extension uses to generate a typed TypeScript client
